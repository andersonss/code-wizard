package br.ufal.ic.compiladores;

import java.io.BufferedReader;
import java.io.IOException;

import br.ufal.ic.compiladores.exceptions.UndefinedTokenException;
import br.ufal.ic.compiladores.tabela.TabelaInterna;
import br.ufal.ic.compiladores.token.ClasseToken;
import br.ufal.ic.compiladores.token.Token;

/**
 * 
 * Retorna o Token contendo a classe, valor e posicao.
 * 
 */
public class AnalisadorLexico {

<<<<<<< .mine
	private int posLinha = 1;
	private int posColuna = 1;
	private final BufferedReader buffer;
	private char charBuff;
	private final char EOLR = '\r';
	private final char EOLN = '\n';
	private final char EOF = (char) -1;
=======
    private static int posLinha = 1;
    private static int posColuna = 1;
    private static BufferedReader buffer;
    private static char charBuff;
    private static final char EOLR = '\r';
    private static final char EOLN = '\n';
    private static final char EOF = (char) -1;
>>>>>>> .r56

<<<<<<< .mine
	/* delimitar os caracteres aceitos pela linguagem */
	private final int ASCII_INI = 32;
	private final int ASCII_FIM = 126;
=======
    /* delimitar os caracteres aceitos pela linguagem */
    private static final int ASCII_INI = 32;
    private static final int ASCII_FIM = 126;
>>>>>>> .r56

<<<<<<< .mine
	/**
	 * 
	 * @param buffer
	 * @throws IOException
	 */
	public AnalisadorLexico(BufferedReader buffer) throws IOException {
		this.buffer = buffer;
		charBuff = (char) buffer.read();
	}
=======
       
    public static void setBuffer(BufferedReader buffer) throws IOException {
    	AnalisadorLexico.buffer = buffer;
    	charBuff = (char) buffer.read();
	}
>>>>>>> .r56

<<<<<<< .mine
	/**
	 * le o proximo caracter e incrementa o contador de coluna
	 * 
	 * @throws IOException
	 */
	private void lerBuffer() {
		posColuna++;
		try {
			charBuff = (char) buffer.read();
		} catch (IOException e) {
			System.err.println("Erro na leitura do arquivo!");
			e.printStackTrace();
		}
=======


	/**
     * le o proximo caracter e incrementa o contador de coluna
     * 
     * @throws IOException
     */
    private static void lerBuffer() {
	posColuna++;
	try {
	    charBuff = (char) buffer.read();
	} catch (IOException e) {
	    System.err.println("Erro na leitura do arquivo!");
	    e.printStackTrace();
>>>>>>> .r56
	}

<<<<<<< .mine
	/**
	 * 
	 * @return Token
	 * @throws UndefinedTokenException
	 */
	public Token nextToken() throws UndefinedTokenException {
=======
    /**
     * 
     * @return Token
     * @throws UndefinedTokenException
     */
    public static Token nextToken() throws UndefinedTokenException {
>>>>>>> .r56

		int posXInit;
		int posYInit;
		ClasseToken classe = null;
		String lexema = "";

		// percorre ate encontrar algo diferente de espaco ou enter ou chegar ao
		// final do arquivo.
		while (charBuff == EOLR || charBuff == EOLN
				|| Character.isWhitespace(charBuff) || charBuff == EOF) {
			// Windows = \r\n, mac = \r, unix = \n
			if (charBuff == EOLR) {
				posColuna = 0;
				posLinha++;
				lerBuffer();
				if (charBuff == EOLN) {
					posColuna = 0;
					lerBuffer();
				}
			} else if (charBuff == EOLN) {
				posColuna = 0;
				posLinha++;
				lerBuffer();
			} else if (charBuff == EOF) {
				return null;
			} else {
				lerBuffer();
			}
		}

		// posicao do token
		posXInit = posColuna;
		posYInit = posLinha;

<<<<<<< .mine
		if (Character.isLetter(charBuff)) {
			while (Character.isLetterOrDigit(charBuff)) {
				lexema += charBuff;
				lerBuffer();
			}
			if (TabelaInterna.contains(lexema)) {
				classe = TabelaInterna.getTokenClass(lexema);
			} else {
				classe = ClasseToken.ID;
			}
		} else if (Character.isDigit(charBuff)) {
			int quantPonto = 0;
			while (Character.isDigit(charBuff) || charBuff == '.') {
				if (charBuff == '.') {
					if (++quantPonto > 1) {
						throw new UndefinedTokenException(
								String.valueOf(charBuff), posLinha, posColuna);
					}
				}
				lexema += charBuff;
				lerBuffer();
			}
			classe = ClasseToken.CONST_NUM;
		} else if (charBuff == '"') {
			// captura cadeia de caracteres
			lexema += charBuff;
			lerBuffer();
			while (charBuff >= ASCII_INI && charBuff <= ASCII_FIM) {
				if (charBuff == '"') {
					lexema += charBuff;
					classe = ClasseToken.CADEIA_CARACTER;
					lerBuffer();
					break;
				}
				lexema += charBuff;
				lerBuffer();
			}
		} else if (charBuff == '\'') {
			// captura char
			lexema += charBuff;
			lerBuffer();
			if (Character.isLetter(charBuff)) {
				lexema += charBuff;
				lerBuffer();
				if (charBuff == '\'') {
					lexema += charBuff;
					classe = ClasseToken.CARACTER;
					lerBuffer();
				} else {
					throw new UndefinedTokenException(lexema, posLinha,
							posColuna);
				}

			}
=======
	if (Character.isLetter(charBuff)) {
	    while (Character.isLetterOrDigit(charBuff)) {
		lexema += charBuff;
		lerBuffer();
	    }
	    if (TabelaInterna.contains(lexema)) {
		classe = TabelaInterna.getTokenClass(lexema.toLowerCase());
	    } else {
		classe = ClasseToken.ID;
	    }
	} else if (Character.isDigit(charBuff)) {
	    int quantPonto = 0;
	    while (Character.isDigit(charBuff) || charBuff == '.') {
		if (charBuff == '.') {
		    if (++quantPonto > 1) {
			throw new UndefinedTokenException(
				String.valueOf(charBuff), posLinha, posColuna);
		    }
		}
		lexema += charBuff;
		lerBuffer();
	    }
	    classe = ClasseToken.CONST_NUM;
	} else if (charBuff == '"') {
	    // captura cadeia de caracteres
	    lexema += charBuff;
	    lerBuffer();
	    while (charBuff >= ASCII_INI && charBuff <= ASCII_FIM) {
		if (charBuff == '"') {
		    lexema += charBuff;
		    classe = ClasseToken.CADEIA_CARACTER;
		    lerBuffer();
		    break;
		}
		lexema += charBuff;
		lerBuffer();
	    }
	} else if (charBuff == '\'') {
	    // captura char
	    lexema += charBuff;
	    lerBuffer();
	    if (Character.isLetter(charBuff)) {
		lexema += charBuff;
		lerBuffer();
		if (charBuff == '\'') {
		    lexema += charBuff;
		    classe = ClasseToken.CARACTER;
		    lerBuffer();
>>>>>>> .r56
		} else {
			// captura operadores e delimitadores e outras coisas
			lexema += charBuff;
			lerBuffer();
			if (TabelaInterna.contains(lexema + charBuff)) {
				lexema += charBuff;
				lerBuffer();
			}
			classe = TabelaInterna.getTokenClass(lexema);
		}

		if (classe == null) {
			// captura coisas q nao foram classificadas
			throw new UndefinedTokenException(lexema, posXInit, posYInit);
		}

		return new Token(classe, lexema, posYInit, posXInit);
	}
}
